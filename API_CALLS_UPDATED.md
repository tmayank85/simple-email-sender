# API Calls Updated for Multi-Server Support

## 🔄 **Updated API Endpoints**

### 1. **Create User API** (`POST /api/admin/users`)

**Payload now includes:**
```json
{
  // Basic user fields
  "userName": "John Doe",
  "email": "john@example.com", 
  "password": "secure123",
  "activeTill": "2024-12-31T00:00:00.000Z",
  "isActive": true,
  
  // Legacy fields (backward compatibility)
  "orcaServerUrl": "",
  "oldServerDetail": "",
  "newServerDetail": "",
  "oldServerEmailCount": 0,
  "newServerEmailCount": 0,
  
  // NEW: Multi-server support
  "servers": [],
  "defaultServerId": ""
}
```

### 2. **Update User API** (`PUT /api/admin/users/:id`)

**Payload now includes:**
```json
{
  // Basic user fields
  "userName": "John Doe Updated",
  "email": "john.updated@example.com",
  "password": "newpassword123", // Optional - only if changing
  "activeTill": "2025-12-31T00:00:00.000Z",
  "isActive": true,
  
  // Legacy fields (backward compatibility) 
  "orcaServerUrl": "https://legacy.server.com",
  "oldServerDetail": "legacy-host;192.168.1.50;2024-01-01",
  "newServerDetail": "new-host;192.168.1.51;2024-08-01",
  "oldServerEmailCount": 100,
  "newServerEmailCount": 250,
  
  // NEW: Multi-server support
  "servers": [
    {
      "serverId": "server_abc123", // Auto-generated by backend
      "serverName": "Production Server",
      "serverUrl": "https://prod.server.com:4000",
      "serverIp": "192.168.1.100",
      "emailCount": 500,
      "uptime": 86400,
      "lastSeen": "2024-08-28T10:30:00.000Z",
      "isActive": true,
      "serverDetail": "prod-host;192.168.1.100;2024-08-01T00:00:00Z"
    },
    {
      "serverId": "server_def456",
      "serverName": "Backup Server", 
      "serverUrl": "https://backup.server.com:4000",
      "serverIp": "192.168.1.101",
      "emailCount": 150,
      "uptime": 43200,
      "lastSeen": "2024-08-28T10:25:00.000Z",
      "isActive": true,
      "serverDetail": "backup-host;192.168.1.101;2024-08-15T00:00:00Z"
    }
  ],
  "defaultServerId": "server_abc123"
}
```

## 🚀 **Backend Requirements**

### **Expected Backend Behavior:**

1. **Create User:**
   - Accept all new fields in the payload
   - Initialize empty `servers` array if not provided
   - Set `defaultServerId` to empty string if not provided
   - Maintain all legacy fields for backward compatibility

2. **Update User:**
   - Update all provided fields
   - Handle `servers` array completely (replace existing servers)
   - Update `defaultServerId` if provided
   - Validate that `defaultServerId` exists in the `servers` array
   - Auto-generate `serverId` for any servers without IDs

3. **Server ID Generation:**
   - Backend should auto-generate unique `serverId` values
   - Format suggestion: `server_${timestamp}_${randomString}`
   - Ensure uniqueness across all users and servers

## 🔍 **Validation Requirements**

### **Frontend Validation (Already Implemented):**
- ✅ Server Name required
- ✅ Server URL required and valid URL format
- ✅ Email Count must be non-negative number
- ✅ Default Server ID must exist in servers array

### **Backend Validation (Recommended):**
- Validate server URLs are reachable (optional)
- Ensure serverId uniqueness
- Validate defaultServerId exists in servers array
- Check email format and user permissions

## 📊 **Data Flow**

### **User Creation Flow:**
1. **Frontend:** User fills basic info → sends to API
2. **Backend:** Creates user with empty servers array
3. **Admin:** Later adds servers via edit form
4. **Backend:** Generates server IDs and updates user

### **User Update Flow:**
1. **Frontend:** Admin manages servers in edit modal
2. **API Call:** Complete user object with servers array
3. **Backend:** Validates and updates all fields
4. **Response:** Updated user with real server IDs

## ✅ **Compatibility Notes**

- **Backward Compatible:** All legacy fields preserved
- **Progressive Enhancement:** New features don't break existing functionality
- **Graceful Degradation:** Works with or without servers array
- **Migration Safe:** Existing users continue to work normally

The API calls now fully support the multi-server architecture while maintaining complete backward compatibility! 🎉
